# ⚖️ 核心决策日志 (v2.0)

> **人类专用**: 本文档记录了项目中最重要、最不可轻易更改的核心决策。在对架构或核心功能提出任何修改建议前，AI必须查阅此文档。

## 决策模板

```markdown
### [决策标题]

- **决策ID**: D[XXX]
- **决策日期**: YYYY-MM-DD
- **决策内容**: [清晰地描述最终的决策]。
- **决策理由**: [简要说明为什么做出这个决策，以及它解决了什么问题]。
- **影响范围**: [说明此决策对哪些模块或流程有影响]。
```

---

## 核心架构决策

### 采用“应用装置”模型
- **决策ID**: D001
- **决策日期**: 2025-08-06
- **决策内容**: CodeRunner 的核心产品是“应用装置 (Appliance)”，即基于 AgentSphere 的预定义沙箱模板（如 Node.js 模板、PostgreSQL 模板）。整个后端服务是一个围绕 AgentSphere SDK 的“业务流程编排器”。
- **决策理由**: 此模型极大地简化了系统架构，降低了开发复杂性，并能充分利用 AgentSphere 的能力。
- **影响范围**: 全局。这是 `01-system-design.md` v2.0 的核心基础。

### 使用 PostgreSQL 存储自身状态
- **决策ID**: D002
- **决策日期**: 2025-08-06
- **决策内容**: CodeRunner 自身的用户、项目、部署等元数据，将存储在 PostgreSQL 数据库中。
- **决策理由**: 关系型数据库非常适合管理实体间的清晰关系，且 PostgreSQL 功能强大、稳定可靠。
- **影响范围**: 所有服务的数据库交互层，具体见 `04-database-schema.md`。

---

## 核心产品决策

### 选择 LowDB v7 作为 Manifest 生成项目的数据库
- **决策ID**: D003
- **决策日期**: 2025-08-07
- **决策内容**: ManifestEngine 生成的所有项目将使用 LowDB v7 作为数据存储方案，而非 SQLite 或其他数据库。
- **决策理由**: LowDB 是纯 JavaScript 实现，无需编译原生依赖，完美适配 AgentSphere 沙箱环境。零配置即可使用，JSON 格式便于调试，对 MVP/POC 项目性能足够。
- **影响范围**: 所有通过 Manifest YAML 生成的项目。未来可在 Phase 2 提供其他数据库选项。

### ManifestEngine 生成 JavaScript 而非 TypeScript
- **决策ID**: D004
- **决策日期**: 2025-08-07
- **决策内容**: ManifestEngine 生成纯 JavaScript (CommonJS) 代码，而非 TypeScript。
- **决策理由**: 沙箱环境中无需编译步骤，减少依赖和复杂性，启动时间更快。对于 MVP 阶段的快速原型开发更加合适。
- **影响范围**: ManifestEngine 的代码生成逻辑。Phase 2 可考虑添加 TypeScript 输出选项。

### MVP 范围明确界定
- **决策ID**: D005
- **决策日期**: 2025-08-07
- **决策内容**: Phase 1 MVP 仅支持基础 CRUD 功能，不包含认证、GraphQL、WebSocket、数据关系等高级特性。
- **决策理由**: 专注核心价值（YAML→后端转换），快速验证产品概念，降低初期复杂度。
- **影响范围**: ManifestEngine 功能范围，用户期望管理，产品路线图规划。

---

## Phase 2 & Phase 3 执行决策

### Phase 2 按 PHASE2-PLAN.md 执行
- **决策ID**: D006
- **决策日期**: 2025-08-07
- **决策内容**: Phase 2 按照 PHASE2-PLAN.md 的 6 天冲刺计划执行（WebSocket→监控→前端→配置→扩缩容），而非先实现数据库模板。
- **决策理由**: 用户体验优先，先提供实时功能和可视化界面，建立完整的开发者工作流，数据库编排在 Phase 3 实现。
- **影响范围**: Phase 2 整体执行节奏，SubAgent 任务分配，技术栈选择。

### 前端技术栈确认
- **决策ID**: D007
- **决策日期**: 2025-08-07
- **决策内容**: 使用 React 18 + TypeScript + shadcn/ui + Zustand + Socket.io-client 作为前端技术栈。
- **决策理由**: React 18 具备优秀的实时功能支持，shadcn/ui 提供现代化组件，Zustand 轻量化状态管理，整套技术栈适合实时应用开发。
- **影响范围**: 所有前端开发（Phase 2 & Phase 3），组件库选择，状态管理架构，实时通信实现。

### 数据库模板实现优先级
- **决策ID**: D008
- **决策日期**: 2025-08-07
- **决策内容**: Phase 3 数据库模板优先实现 PostgreSQL，然后 Redis。
- **决策理由**: PostgreSQL 是关系型数据库，大多数应用都需要持久化关系型数据存储，使用频率更高。Redis 作为缓存和会话存储，虽然重要但属于增强功能。
- **影响范围**: Phase 3 任务执行顺序，DevOps 工作量分配，模板开发复杂度。

### 多租户数据库隔离策略
- **决策ID**: D009
- **决策日期**: 2025-08-07
- **决策内容**: PostgreSQL 多租户采用每租户独立数据库的隔离策略。
- **决策理由**: 提供最强的数据隔离性和安全性，实现相对简单，适合 MVP 阶段。虽然资源开销较大，但在用户量不大的初期是可接受的。
- **影响范围**: 数据库模板设计，资源配额管理，备份恢复策略，多租户架构实现。

### Phase 3 UI 开发策略
- **决策ID**: D010
- **决策日期**: 2025-08-07
- **决策内容**: Phase 3 的高级管理功能将扩展 Phase 2 的 React 应用，而非创建独立的管理后台。
- **决策理由**: 复用已有的组件、WebSocket连接、状态管理等基础设施，保持统一的用户体验，降低开发和维护成本。
- **影响范围**: Phase 3 前端开发方式，代码库结构，用户认证流程，路由设计。
